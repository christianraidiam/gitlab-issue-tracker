<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitLab Issues SLA Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #041920;
      color: #f1f1f1;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    header img {
      height: 40px;
      background-color: #fff;
      border-radius: 6px;
      padding: 2px;
    }
    h1 {
      font-size: 28px;
      color: #00e38c;
    }
    h2 {
      font-size: 20px;
      margin-top: 40px;
      color: #00e38c;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 10px;
      background-color: #06292f;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #0a2e33;
      color: #00e38c;
    }
    tr:nth-child(even) td {
      background-color: #0d383e;
    }
    .over-sla {
      color: #ff6b6b;
      font-weight: bold;
    }
    .within-sla {
      color: #00e38c;
    }
    .label-badge {
      display: inline-block;
      background-color: #055b4e;
      color: #00e38c;
      border-radius: 4px;
      padding: 2px 6px;
      margin: 2px 4px 2px 0;
      font-size: 12px;
    }
    button, select {
      background-color: #00e38c;
      color: #041920;
      border: none;
      padding: 8px 14px;
      margin-top: 10px;
      margin-right: 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    select {
      padding: 6px 12px;
    }
    .summary {
      font-size: 14px;
      margin-top: 10px;
    }
    .comment-box {
      width: 100%;
      font-size: 12px;
      background-color: #092e34;
      color: #ffffff;
      border: 1px solid #066f5f;
      border-radius: 4px;
    }
    #clearFilterText {
      display: none;
      font-size: 13px;
      margin-top: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      color: #00e38c;
      text-decoration: underline;
    }
    #loading {
      display: none;
      margin-top: 10px;
      color: #00e38c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <img src="Raidiam_icon.png" alt="Raidiam Logo" />
    <h1>GitLab Issues SLA Dashboard</h1>
  </header>

  <p><strong>SLA:</strong> 10 working days (Monday to Friday)</p>
  <div>
    <label for="tagFilter">Filter by tag:</label><br>
    <select id="tagFilter" onchange="applyTagFilter()">
      <option value="">All</option>
    </select>
    <div id="clearFilterText" onclick="clearFilters()">Clear filter</div>
    <div style="margin-top: 10px;">
      <button onclick="loadAllIssues()">üîÑ Refresh</button>
      <button onclick="clearAllComments()">üóëÔ∏è Clear All Comments</button>
    </div>
    <div id="loading">Loading issues, please wait...</div>
  </div>

  <h2>Open Finance Issues</h2>
  <div class="summary" id="finance-summary"></div>
  <table id="finance-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Created At</th>
        <th>Working Days Open</th>
        <th>SLA Status</th>
        <th>Tags</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Open Insurance Issues</h2>
  <div class="summary" id="insurance-summary"></div>
  <table id="insurance-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Created At</th>
        <th>Working Days Open</th>
        <th>SLA Status</th>
        <th>Tags</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function workingDaysBetween(startDate, endDate) {
      let count = 0;
      const cur = new Date(startDate);
      while (cur <= endDate) {
        const day = cur.getDay();
        if (day !== 0 && day !== 6) count++;
        cur.setDate(cur.getDate() + 1);
      }
      return count;
    }

    function saveComment(key, value) {
      localStorage.setItem(key, value);
    }

    function clearAllComments() {
      const textareas = document.querySelectorAll('.comment-box');
      textareas.forEach(area => {
        localStorage.removeItem(area.dataset.key);
        area.value = '';
      });
    }

    function clearFilters() {
      document.getElementById('tagFilter').value = '';
      applyTagFilter();
    }

    function applyTagFilter() {
      const value = document.getElementById("tagFilter").value;
      document.getElementById("clearFilterText").style.display = value ? "block" : "none";
      renderIssues();
    }

    let allIssues = [];

    async function loadAllIssues() {
      document.getElementById("loading").style.display = "block";
      allIssues = [];
      document.getElementById("tagFilter").innerHTML = '<option value="">All</option>';
      await loadIssues(26426113, 'finance-table'); // Open Finance
      await loadIssues(32299006, 'insurance-table'); // Open Insurance
      populateTagFilter();
      renderIssues();
      document.getElementById("loading").style.display = "none";
    }

    async function loadIssues(projectId, tableId) {
      const res = await fetch(`https://gitlab.com/api/v4/projects/${projectId}/issues?state=opened`);
      const data = await res.json();
      data.forEach(issue => {
        issue.projectId = projectId;
        issue.tableId = tableId;
        allIssues.push(issue);
      });
    }

    function renderIssues() {
      const tagFilter = document.getElementById("tagFilter").value;
      const tables = { 'finance-table': [], 'insurance-table': [] };
      const summaries = { 'finance-table': { total: 0, overSLA: 0 }, 'insurance-table': { total: 0, overSLA: 0 } };

      document.querySelectorAll("tbody").forEach(tb => tb.innerHTML = '');

      allIssues.forEach(issue => {
        if (tagFilter && !issue.labels.includes(tagFilter)) return;

        const created = new Date(issue.created_at);
        const days = workingDaysBetween(created, new Date());
        const isOver = days > 10;
        const commentKey = `comment-${issue.projectId}-${issue.iid}`;
        const saved = localStorage.getItem(commentKey) || "";

        const row = `
          <tr>
            <td><a href="${issue.web_url}" target="_blank" style="color:#00e38c;">#${issue.iid}</a></td>
            <td>${issue.title}</td>
            <td>${created.toLocaleDateString()}</td>
            <td>${days}</td>
            <td class="${isOver ? 'over-sla' : 'within-sla'}">${isOver ? 'Over SLA' : 'Within SLA'}</td>
            <td>${issue.labels.map(label => `<span class='label-badge'>${label}</span>`).join(' ')}</td>
            <td><textarea class="comment-box" rows="2" data-key="${commentKey}" oninput="saveComment('${commentKey}', this.value)">${saved}</textarea></td>
          </tr>`;

        document.querySelector(`#${issue.tableId} tbody`).innerHTML += row;
        summaries[issue.tableId].total++;
        if (isOver) summaries[issue.tableId].overSLA++;
      });

      document.getElementById("finance-summary").textContent = `${summaries["finance-table"].total} issues, ${summaries["finance-table"].overSLA} over SLA`;
      document.getElementById("insurance-summary").textContent = `${summaries["insurance-table"].total} issues, ${summaries["insurance-table"].overSLA} over SLA`;
    }

    function populateTagFilter() {
      const allLabels = new Set();
      allIssues.forEach(i => i.labels.forEach(l => allLabels.add(l)));
      const filter = document.getElementById("tagFilter");
      allLabels.forEach(label => {
        const opt = document.createElement("option");
        opt.value = label;
        opt.textContent = label;
        filter.appendChild(opt);
      });
    }

    loadAllIssues();
  </script>
</body>
</html>
